# Terraform Beginner Bootcamp 2023

## Table of contents

- [Terraform Beginner Bootcamp 2023](#terraform-beginner-bootcamp-2023)
  - [Table of contents](#table-of-contents)
  - [Desired setup](#desired-setup)
  - [Semantic Versioning](#semantic-versioning)
  - [AWS CLI](#aws-cli)
    - [Commands](#commands)
  - [Terraform CLI](#terraform-cli)
    - [Registry](#registry)
    - [Commands](#commands-1)
    - [Lock files](#lock-files)
    - [State files](#state-files)
    - [Directory structure](#directory-structure)
  - [Terraform Cloud](#terraform-cloud)
  - [Root Module Structure](#root-module-structure)
  - [Loading Terraform variables](#loading-terraform-variables)

## Desired setup

![setup](./images/terratown.png)

## Semantic Versioning

This project is going to utilize [semantic versioning](https://semver.org/) for its tagging.

Given a version number **MAJOR.MINOR.PATCH**, increment the:

- **MAJOR** version when you make incompatible API changes
- **MINOR** version when you add functionality in a backward compatible manner
- **PATCH** version when you make backward compatible bug fixes

## AWS CLI

In order for the CLI to work correctly, we need to [set some environment variables](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html).

**To set for all sessions:**

```sh
setx AWS_ACCESS_KEY_ID AKIAIOSFODNN7EXAMPLE
setx AWS_SECRET_ACCESS_KEY wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
setx AWS_DEFAULT_REGION us-west-2
```

### Commands

- `aws sts get-caller-identity` - check if AWS credentials is configured correctly

## Terraform CLI

### Registry

Terraform sources their providers and modules from the Terraform registry which is located at [registry.terraform.io](http://registry.terraform.io).

- **Providers** are interfaces to APIs that allow to create resources in Terraform
   - [Random Terraform Provider](https://registry.terraform.io/providers/hashicorp/random)
- **Modules** are a way to make large amounts of terraform modular, portable and shareable.

### Commands

We can see a list of all Terraform commands by simply typing `terraform`.

- `terraform init` - at the start of a new project we need to run this command to download the binaries for the terraform providers that are used in the project. This needs to be ran whenever a new provider is added, to download the necessary binaries
- `terraform plan` - generates a changeset about the state of the instrastrucutre and what will be changed
- `terraform apply` - runs a plan and passes the changeset to be executed. Manual approval is required to actually create the resources
- `terraform apply --auto-approve` - `--auto-approve` is used to skip the prompt for the manual approval
- `terraform output`
- `terraform destroy` - destroys all the created resources. Manual approval is required to actually destroy the resources
- `terraform destroy --auto-approve` - `--auto-approve` is used to skip the prompt for the manual approval

### Lock files

`.terraform.lock.hcl` contains the locked versioning for the providers or modules that should be used with this project.

The Terraform lock file **should** be committed to git.

### State files

Contains information about the current state of the infrastructure.

The Terraform state file **should not** be committed to git, as it can contain sensitive data.

If this file is lost, the state of the current inftrastructure is lost.

`.terraform.tfstate.backup` is the previous state generated by Terraform, before the new changeset was applied.

### Directory structure

- `.terraform` - contains executables for Terraform providers used in the infrastructure.

## Terraform Cloud

In order to manage the state file remotely, we can use Terraform Cloud. For this, we need to create a project (optional) and a workspace (required), and to add the `cloud` configuration in our `terraform` code.

In order to transfer the local state to Terraform Cloud, we need to sign in locally using the `terraform login` command. This opens up the [browser](https://app.terraform.io/app/settings/tokens) to generate a Token. This token is then pasted into the terminal, and a session is created locally, which is saved in the `C:\Users\{CURRENT_USER}\AppData\Roaming\terraform.d\credentials.tfrc.json` file.

Alternatively, we can setup the token generated in Terraform Cloud into a System Variable named `TF_TOKEN_app_terraform_io`.

## Root Module Structure

The root module structure, based on the [official hashicorp documentation](https://developer.hashicorp.com/terraform/language/modules/develop/structure), is as follows:

- PROJECT_ROOT
  - main.tf - everything else
  - variables.tf - stores the structure of input variables
  - providers.tf - defines required providers and their configuration
  - outputs.tf - stores the outputs
  - terraform.tfvars - stores the data of variables we want to load into our terraform project
  - README.md - required for root modules

## Loading Terraform variables

Locally we can have a `terraform.tfvars` file, to keep all the necessary variables. This file should not be committed to source control. An example file is under `terraform.tfvars.example`.

We can use the `-var` flag to set an input variable or override a variable from tfvars, i.e. `terraform plan -var user_uuid="SOME_GUID_HERE"`.

In Terraform Cloud, the required variables are added in the Variables of the Workspace.
